#!/bin/sh
lang="${1-de}"
lang="${lang%.txt}"
charset="${2}"
utf8="cat"
if test "${lang}" = "en"
then
	for c in src/iroffer*.c src/dinoex*.c
	do
		if test -f "${c}.en"
		then
			echo \
			mv -f "${c}.en" "${c}"
			mv -f "${c}.en" "${c}"
		fi
	done
	exit 0
fi
case "${charset}" in
u*)
	echo "utf-8 enabled ..."
	utf8="iconv -f latin1 -t utf-8"
	;;
esac
echo -n "parsing ... "
grep -v "^#" "${lang}.txt" |
while read nr text
do
	if ! grep -q "^${nr} " en.txt
	then
		continue
	fi
	en=`grep "^${nr} " "en.txt"`
	en="${en#* }"
	text=`grep "^${nr} " "${lang}.txt"`
	text="${text#* }"
	if test "${en}" = "${text}"
	then
		continue
	fi
	echo "s°${en}°${text}°"
done |
${utf8} |
sed -e 's|\\|\\\\|g' -e 's|\*|\\*|g' -e 's|\+|\\+|g' -e 's|\.|\\.|g' -e 's|\[|\\[|g' -e 's|\]|\\]|g' > "${lang}.sed"
echo "done"
for c in src/iroffer*.c src/dinoex*.c
do
	if test ! -f "${c}.en"
	then
		echo \
		cp -p "${c}" "${c}.en"
		cp -p "${c}" "${c}.en"
	fi
	sed -f "${lang}.sed" "${c}".en > "${c}.new"
	if diff -q "${c}" "${c}.new"
	then
		rm -f "${c}.new"
		continue
	fi
	echo \
	mv -f "${c}.new" "${c}"
	mv -f "${c}.new" "${c}"
done
# eof
